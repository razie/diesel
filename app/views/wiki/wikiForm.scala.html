@********
special handlng of forms
*********@
@(wid:model.WID, iname:Option[String], page:Option[model.WikiEntry], user:Option[model.User], errors:Map[String,String])
@import model._

@htmlHead(page.flatMap(_.contentTags.get("title")).getOrElse(wid.cat +": "+ page.map(_.label).getOrElse(model.Wikis.label(wid))))
@navbar(user)

@isClubAdmin(u: User) = @{
	page.flatMap(_.owner).exists(controllers.RazWikiAuthorization.isClubAdmin(u, _))
}

@prevNext(wids:Seq[WID]) = {
  @wids.splitAt(wids.indexOf(wid))._1.lastOption.map{x=>
    <a href="@controllers.Wiki.w(x)" class="btn btn-mini"><font style="color:orange">&laquo;</font> PREVIOUS</a>
    }.getOrElse {
    <a href="#" class="btn btn-mini disabled"><font style="color:orange">&laquo;</font> PREVIOUS</a>
    }
  form (@(wids.indexOf(wid)+1) of @wids.size): 
  @wids.splitAt(wids.indexOf(wid))._2.tail.headOption.map{x=>
    <a href="@controllers.Wiki.w(x)" class="btn btn-mini">NEXT <font style="color:orange">&raquo;</font></a>
    }.getOrElse {
    <a href="#" class="btn btn-mini disabled">NEXT <font style="color:orange">&raquo;</font></a>
    }
}

   
<div class="container">
  <div class="row">
    <div class="span9">

      <div class="well">
      
@if(!errors.isEmpty) {
<div class="alert alert-error">
  <font style="color:red"><strong>Form has errors</strong> (was not saved):</font><ul>
  <font style="color:red">
        @errors.map {err=>
        	<li><b>@err._1</b>  => @err._2 </li>
        	}
  </ul></font>
</div>
}

<form action="/doe/form/submit/@wid.wpath" method="POST">

@regs.headOption.map(_.wids).map {wids=>
<div class="alert alert-info">
<strong>Registration forms:</strong>  @prevNext(wids)
</div>
}  

        @wiki.wikiFrag(wid,user,false,page, iname, false, false)

@if(!errors.isEmpty) {
  <hr>
<div class="alert alert-error">
  <strong><a id="errors">Errors:</a></strong><ul>
  <font style="color:red">
        @errors.map {err=>
        	<li><b>@err._1</b>  => @err._2 </li>
        	}
  </ul></font>
</div>
}

        <hr>

@if(page.exists(_.form.canEdit) ||
  user.exists(isClubAdmin(_)) &&
  (page.get.form.canBeApproved || page.get.form.canBeRejected)) {
}

@if(page.exists(_.form.canEdit)){
        <input type="submit" name="save_button" value="Save for later" class="btn btn-info">
        <input type="submit" name="submit_button" value="Submit for approval" class="btn btn-success">
  	<strong>Please <font style="color:red">save or submit</font> before leaving this page!</strong>
        }
@if(user.exists(isClubAdmin(_)) && page.get.form.canBeApproved) {
        <input type="submit" name="approve_button" value="Approve" class="btn btn-success">
        }
@if(user.exists(isClubAdmin(_)) && (page.get.form.canBeApproved || page.get.form.canBeRejected)) {
        <input type="submit" name="reject_button" value="Reject" class="btn btn-danger">
        <p>
        <textarea name="formRejected" value="Reject reason" rows="3" placeholder="reason for rejection" class="input-xxlarge"></textarea>
        }

@*********        
for registration sequences - show prev/next
*********@
@regs=@{
  val clubs = user.toList.flatMap(_.wikis).filter(_.wid.cat=="Club").flatMap(w=>model.Users.findUserByUsername(w.wid.name).toList)
  clubs.flatMap(c=>model.Regs.findClubUser(c, user.get._id)).filter(_.wids.contains(wid))
}
@regs.headOption.map(_.wids).map {wids=>
	<hr>
  <p><div class="alert alert-info">
  <strong>Registration forms:</strong>  @prevNext(wids)

  @wids.lastOption.map{x=>
  }

  @if(wids.size > 1) {
  	@club.userFormList(wids, false, Some(wid))
    }
    </div>
  }
      </form>
      </div>

      @wiki.wikiAddMore(wid, page, user)

      @wiki.wikiPageComments(wid, page, user)

      <hr>
      @htmlFooter(ads=true)

    </div> <!-- /span9 -->

    <div class="span3">
    @wiki.wikiFrag(WID("Admin","Right"),user,true)

    @addRight()
    </div>

  </div> <!-- row -->
</div> <!-- /container -->

@htmlBottom()
    