@**************
wiki fragment, used in another page
**************@
@(we: razie.wiki.model.WikiEntry, simple: Boolean = false, canEdit: Boolean = false, isSite: Boolean = false, print: Boolean = false)(implicit stok: controllers.StateOk)
@import controllers.IgnoreErrors
@import razie.wiki.model.{Wikis, WikiCount, WID, WikiEntry}
@import _root_.razie.wiki.Services
@import razie.clog

@page=@{Option(we)}
@wid=@{we.wid}

@rss = @{
  page.flatMap(_.contentProps.get("rss")).getOrElse(controllers.Wiki.w(wid) + "/rss.xml")
}

@prepend(l: List[String], c: String) = @{
  c :: l
}

@ww() = @{
  Wikis(wid.getRealm).findAny(wid.name)
}

@url() = @{
  val u = wid.url
  if(u startsWith "http") u else s"http://${Services.config.hostport}$u"
}

@if(!simple && !print) {
  <div id="wikiBy">
    <small>
      @if(!isSite) {
        <em>By</em>:
        @**todo use separate page for missing users **@
        <a href="/user/@model.Users.nameOf(page.get.by)">@model.Users.nameOf(page.get.by)</a>
        | <small>
          @page.get.crDtm.toLocalDate().toString
          @if(page.get.updDtm.toLocalDate != page.get.crDtm.toLocalDate) { .. @page.get.updDtm.toLocalDate().toString}
        </small>
      }
      @******* tags *******@

      @** todo tag-based browsing **@
      @if(page.exists(_.tags.size > 0)) {
        | <em>Tags</em>:
        @page.get.tags.map { t =>
          @Html(controllers.Wiki.hrefTag(stok.realm, wid, t, t)) @if(t != page.get.tags.last) {,}
        }
      }
      @******* likes *******@

    |

      @if(stok.au.exists(_.isActive) && page.exists(p => !(p.likes contains stok.au.get._id.toString))) {
        <a href="@routes.Wikie.like(wid, 1)" class="glyphicon glyphicon-thumbs-up" title="This topic is helpful"></a>
      } else {
        @if(stok.au.exists(_.isActive)) {
          <span class="glyphicon glyphicon-thumbs-up" title="You already rated this topic"></span>
        } else {
          <span class="glyphicon glyphicon-thumbs-up" title="Need to login to rate topic"></span>
        }
      }
      @if(page.exists(_.likes.size > 0)) {
        <span style="font-size : x-small">(@page.get.likes.size)</span>
      }
      @**
      @if(stok.au.exists(_.isActive)) {
      &nbsp; <a href="@routes.Wikie.like(wid, 0)" class="glyphicon glyphicon-thumbs-down" title="This topic is not helpful"></a>
      } else {
      &nbsp; <span class="glyphicon glyphicon-thumbs-down" title="Need to login to rate topic"></span>
      }
      @if(page.exists(_.dislikes.size > 0)) {
      <span style="font-size: x-small">(@page.get.dislikes.size)</span>
      }
      **@

    </small>
  </div>
  </p>

  @wid.parentWid.map { pwid =>
    <hr>
  See more in: <strong><a href="@controllers.Wiki.w(pwid)">@pwid.getLabel</a> </strong>
  @if(stok.au.isEmpty && pwid.cat == "Blog") {
    <a class="btn btn-info" title="Subscribe to updates via email" href="@routes.Wikil.linkFollower1(pwid)"><i class="icon-envelope icon-white"></i>
      Subscribe</a>
  }
  }

  <hr>
  <div id="wikiBottomMenu">
    @page.flatMap(x => WikiCount.findOne(x._id)).map { pw =>
      <p><small>Viewed <strong>@pw.count</strong> times</small>
    }
    <small>
      (
      @if(canEdit && wid.cat != "Form" || stok.au.exists(_.hasPerm(model.Perm.adminDb))) {
        <a href="@routes.Wikie.wikieEdit(page.get.wid)">Edit</a>
      }
      @stok.au.map { u =>
        | <a href="@routes.Wiki.wikiBrowse(wid.wpath, "")">Browse</a>
        | <a href="@routes.Wikie.report(wid)">Report</a>
      }
      | <a href="@routes.Wiki.printWid(WID.cmdfromPath(wid.wpath).get, wid.getRealm)">Print</a>
      @if(stok.au.exists(_.hasPerm(model.Perm.adminDb))) {
        | <a href="@routes.Wiki.wikieDebug(wid)"><em>debug</em></a>
        | <a href="@routes.Wiki.wikieUsage(wid)"><em>usage</em></a>
      }
      @if(!(Array("WikiLink", "Category", "Form") contains wid.cat)) {
        @if(canEdit) {
          | <a href="@routes.Wikie.wikieRename1(wid)">Rename</a>
        }
        @if(stok.au.isDefined && stok.au.get.isActive) {

          @defining(stok.au.get.isLinkedTo(we.uwid)) { isLinked =>
            @if(isLinked) {
              | <a href="@routes.Wikil.unlinkUser(wid)">@wid.label("Unlike", "Unlike")</a>
            } else {
              | <a href="@routes.Wikil.linkUser(wid, false)">@wid.label("Like")</a>
            }

            @if(isLinked && we.parent.isDefined) {
              | <a href="@routes.Wikie.wikieMove1(we._id.toString)">@wid.label("Move", "Move")</a>
            }

            @if(we.isOwner(stok.au.get.id) || stok.au.exists(_.hasPerm(model.Perm.adminDb)) ||
                we.owner.exists(o => o.asInstanceOf[model.User].isClub &&
                    Club.findForUser(o.asInstanceOf[model.User]).flatMap(_.uregAdmin).exists(_._id == stok.au.get._id))) {
              | <a href="@routes.Wikie.manage(we._id.toString)">Manage</a>
            }
          }
        }

        @if(stok.au.isEmpty && "Blog" == wid.cat) {
          | <a href="@routes.Wikil.linkFollower1(wid)"><span style="color : red">Subscribe</span></a>
          }

      }
      ) this page.

      <div id="wikiBottomCopyright">
      @wid.cat match {
        case "WikiLink" if (wid.name.startsWith("User:")) => {
          <br>This link page connects you to ??? TODO ???
          @**
          <a href="/wiki/@razie.wiki.model.Wikis.linkFromName(wid.name).to.toString">@razie.wiki.model.Wikis.linkFromName(wid.name).to.name</a>
          : you can add some notes by <a href="@routes.Wikie.wikieEdit(page.get.wid)">editing</a> it.
          **@
        }
        case "Category" => {
          <br>You cannot edit categories.
        }
        case _ => {
          <br>This content is Copyrighted, all rights reserved.
        }
      }
      </div>
    </small></p>
  </div>
} <!-- /simple -->

