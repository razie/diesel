@**************
a JS with HTML and CSS fiddle
**************@
@(reactor:String,
    args:Map[String,String],
    spec:String,
    story:String,
    specWpath:String,
    storyWpath:String,
    specChanged:Boolean,
    storyChanged:Boolean,
    au:Option[model.User],
    errMsg:Option[String],
    id:String = java.lang.System.currentTimeMillis().toString())(implicit stok:controllers.StateOk)
@import razie.wiki.model.WID

@stok.title("Diesel fiddle")

<style>
.ace-primaryline {
  background-color: yellow;
  position:absolute;
}
</style>

<script src="@routes.Assets.at("javascripts/rk-contentassist-sqbr.js")"></script>
<script src="@routes.Assets.at("javascripts/weFiddles.js")"></script>
<script src="@routes.Assets.at("javascripts/weCommons.js")"></script>

  <h3>Diesel fiddle | <small>
    <input type="checkbox" id="refresh" checked> Real time (<span id="roundtrip">.. ms</span>)
    <span id="errors" class="label label-default">0 failed</span>

    <span onclick="setSpec('Story');" class="label label-primary" style="cursor:pointer">Story <span id="curStory"></span> <span class="glyphicon glyphicon-chevron-down">
    </span></span><span id="storyChanged" class="label label-success" onclick="popupMenu1('Story');" style="cursor:pointer" title="Current draft differs from original">
      <span class="glyphicon glyphicon-floppy-disk"> </span>
  </span>&nbsp;

    <span onclick="setSpec('Spec');" class="label label-primary" style="cursor:pointer">Spec <span id="curSpec"></span> <span class="glyphicon glyphicon-chevron-down">
    </span></span><span id="specChanged" class="label label-success" onclick="popupMenu1('Spec');" style="cursor:pointer" title="Current draft differs from original">
      <span class="glyphicon glyphicon-floppy-disk"> </span>
    </span>&nbsp;

    | <input type="checkbox" id="mockMode" title="Use the mocks" checked> Mocks
    | <input type="checkbox" id="sketchMode" title="Not used yet"> Sketch
    | <input type="checkbox" id="blenderMode" title="Blend all specs together"> Blender
    | <input type="checkbox" id="draftMode" title="Use autosaved drafts not originals" checked> Drafts
    | <input type="checkbox" id="wikiMode" title="Show the wiki instead of the tree" > Wiki
  </small>
  </h3>

@*<a class="btn btn-primary btn-xs" title="Works only on Chrome and Firefox" href="javascript:runpill_@{id}('@{id}')">Run &raquo;</a>*@
@*<br>*@

  <div class="row" style="align-items:center;">
    <div id="title3_@id" class="col-sm-6" style="">
  </div>
    <div id="title4_@id" class="col-sm-6" style="">
  </div>
  </div>
  <div class="row" style="align-items:center;">
    <div id="pre3box_@id" class="col-sm-6" style="">
      <pre id="pre3_@id" style="height:228px; ">@story</pre>
    </div>
    <div class="col-sm-6 well" id="iframew_@id" style="overflow: scroll; margin-bottom:2px">
    </div>
    <pre class="col-sm-6" id="iframe_@id" style="padding:1px; Xtext-align: center">Start typing...</pre>
  </div>

<div class="row" style="align-items:center;">
  <div id="title1_@id" class="col-sm-6" style="">
  </div>
  <div id="title2_@id" class="col-sm-6" style="">
  </div>
</div>
<div class="row" style="align-items:center;">
  <div id="pre1box_@id" class="col-sm-6" style="">
    <pre id="pre1_@id" style="height:228px; ">@spec</pre>
  </div>
  <div class="col-sm-6 well" id="pre2_@id" style="overflow: scroll; margin-bottom:2px">
  </div>
</div>

  <small>Errors in code:</small><br>

  <div style="display:inline-block; width:100%; height:130px; overflow-y:auto;">
    <pre id="pre3b_@id" style="display:inline-block; width:92%; height:119px; margin-bottom:0; padding:0px; border:0;"><code id="codeb_@id">

    </code></pre>
  </div>


@md(f: =>Html)={
  @Html(razie.wiki.model.Wikis.sformat(f.toString(), "md", au))
}

@md{
### Help

Change anything and see your changes **reflected** instantly.

If you need help with the syntax, just click Ctrl+Space (Cmd+Space on Mac).

If you'd rather see the elements ($msg, $when etc) as a dialog, go to that line and press Ctrl+G (Cmd+G on Mac).

}





<script>
var realm = '@reactor';

$('#pre2_'+@id).css('max-height', $('#pre1box_@id').height()-10+'px');
$('#iframew_'+@id).css('max-height', $('#pre3box_@id').height()-10+'px');
$('#iframe_'+@id).css('max-height', $('#pre3box_@id').height()-10+'px');

useLocalStorageCheckbox("sketchMode", "domFiddleSketchMode");
useLocalStorageCheckbox("mockMode", "domFiddleMockMode");
useLocalStorageCheckbox("blenderMode", "domFiddleBlenderMode");
useLocalStorageCheckbox("draftMode", "domFiddleDraftsMode");
useLocalStorageCheckbox("wikiMode", "domFiddleWikiMode");

$('#sketchMode, #mockMode, #blenderMode, #draftMode').change(function(){
      runpill2_@{id}('@{id}');
});

function showHideIframe() {
  if($('#wikiMode').prop('checked')) {
    $('#iframew_@id').show();
    $('#iframe_'+@id).hide();
  } else {
    $('#iframew_@id').hide();
    $('#iframe_@id').show();
  }
};

showHideIframe();

$('#wikiMode').change(function(){
  showHideIframe();
  runpill2_@{id}('@{id}');
});

var domContentAssist=[];
var instContentAssist=[];

var specWpath='@specWpath';
var storyWpath='@storyWpath';

$(document).keyup(function(e) {
  if (e.keyCode == 27) { // escape key maps to keycode `27`
    $("#oneModal").modal('hide');
  }
});

var runpill_@id = function(id) {
  var lastTime = new Date().getTime();
  $.ajax(
    '/dfiddle/buildDom1/'+id+'?@Html(mod.diesel.controllers.SFiddles.qtourl(args))', {
    type: 'POST',
    data: $.param({
      sketchMode : $('#sketchMode').prop('checked'),
      mockMode : $('#mockMode').prop('checked'),
      blenderMode : $('#blenderMode').prop('checked'),
      draftMode : $('#draftMode').prop('checked'),
      reactor : '@reactor',
      specWpath : specWpath,
      storyWpath : storyWpath,
      spec : editor1.getValue(),
      story : editor.getValue()
    }),
    contentType: 'application/x-www-form-urlencoded',
    success: function(data) {
      $('#pre2_'+id).html(data.res);
      domContentAssist = data.ca;
      var du = new Date().getTime() - lastTime;
      $('#roundtrip').text(du+' ms');
      specChanged(data.specChanged);
      // also trigger inst update
      runpill2_@{id}('@{id}');
    },
    error  : function(x) {
      console.log( "ERR "+x.toString());
    }
  });
}

function setErrors (s) {
  $('#errors').text(s + ' failed');
  $('#errors').removeClass();
  if(s == 0 || s == "0")
    $('#errors').addClass("label label-success");
  else
    $('#errors').addClass("label label-danger");
}

var runpill2_@id = function(id) {
  var lastTime = new Date().getTime();
  $.ajax(
    '/dfiddle/buildDom2/'+id+'?@Html(mod.diesel.controllers.SFiddles.qtourl(args))', {
    type: 'POST',
    data: $.param({
      sketchMode : $('#sketchMode').prop('checked'),
      mockMode : $('#mockMode').prop('checked'),
      blenderMode : $('#blenderMode').prop('checked'),
      draftMode : $('#draftMode').prop('checked'),
      reactor : '@reactor',
      specWpath : specWpath,
      storyWpath : storyWpath,
      spec : editor1.getValue(),
      story : editor.getValue()
    }),
    contentType: 'application/x-www-form-urlencoded',
    success: function(data) {
      if($('#wikiMode').prop('checked'))
        $('#iframew_'+id).html(data.wiki);
      else
        $('#iframe_'+id).html(data.res);
      instContentAssist = data.ca;
      setErrors(data.failureCount);
      var du = new Date().getTime() - lastTime;
      $('#roundtrip').text(du+' ms');
      storyChanged(data.storyChanged);
    },
    error  : function(x) {
      console.log( "ERR "+x.toString());
    }
  });
}

if('@specWpath'.length > 0) $("#curSpec").text('(@WID.fromPath(specWpath).map(_.name))');
if('@storyWpath'.length > 0) $("#curStory").text('(@WID.fromPath(storyWpath).map(_.name))');

function specChanged(spec) {
  $('#specChanged').removeClass();
  if(spec === "true") $("#specChanged").addClass("label label-warning");
  else $("#specChanged").addClass("label label-success");
}

function storyChanged(story) {
  $('#storyChanged').removeClass();
  if(story === "true") $("#storyChanged").addClass("label label-warning");
  else $("#storyChanged").addClass("label label-success");
}

function setSpec(what) {
  $.ajax(
    '/dfiddle/domListCat/@reactor/'+what, {
    type: 'GET',
    success: function(data) {
      popupContent("Select "+what+"<br><br>"+data);
    },
    error  : function(x) {
      popupContent("ERR... can't set spec<p>"+x);
    }
  });
}

function popupMenu1(what) {
  //todo get the diffs
  $.ajax(
    '/dfiddle/diffDom/@id', {
    type: 'POST',
    data: $.param({
      reactor : '@reactor',
      specWpath : specWpath,
      storyWpath : storyWpath,
      spec : editor1.getValue(),
      story : editor.getValue()
    }),
    contentType: 'application/x-www-form-urlencoded',
    success: function(data) {
    var cant = '@reactor' == "specs" ? "<small><b>You cannot save in <em>this</em> reactor!</b></small>" : "";
      var tex = "Save/revert "+what+"<br>"+cant+"<br>"+
       '<a href="#" onclick="revertOrig(\''+what+'\'); return false;">Revert</a> | ' +
       '<a href="#" onclick="saveOrig(\''+what+'\'); return false;">Save</a> | ' +
       '<a href="#" onclick="saveNew(\''+what+'\'); return false;">Save as</a> ' +
       '<input name="news" id="news" type="text" placeholder="new topic name"></input>' +
        '<hr>Local changes:' ;
      if(what == "Spec") {
        popupContent(tex + data.specDiff);
      } else if(what == "Story") {
        popupContent(tex + data.storyDiff);
      }
    },
    error  : function(x) {
      console.log( "ERR "+x.toString());
    }
  });
}

function revertOrig(what) {
  console.log("revert.."+what);
  //todo get the diffs
  $.ajax(
    '/dfiddle/revert/@id/'+what, {
    type: 'POST',
    data: $.param({
      reactor : '@reactor',
      specWpath : specWpath,
      storyWpath : storyWpath,
      spec : editor1.getValue(),
      story : editor.getValue()
    }),
    contentType: 'application/x-www-form-urlencoded',
    success: function(data) {
      location.reload(true);
    },
    error  : function(x) {
      console.log( "ERR "+x.toString());
    }
  });

}

function saveOrig(what) {
  console.log("save.."+what);
  //todo get the diffs
  $.ajax(
    '/dfiddle/save/@id/'+what, {
    type: 'POST',
    data: $.param({
      newName : '',
      reactor : '@reactor',
      specWpath : specWpath,
      storyWpath : storyWpath,
      spec : editor1.getValue(),
      story : editor.getValue()
    }),
    contentType: 'application/x-www-form-urlencoded',
    success: function(data) {
      location.reload(true);
    },
    error  : function(x) {
      console.log( "ERR "+x.toString());
    }
  });
}

function saveNew(what) {
  console.log("saveNEW.."+what);
  var name = $("#news").val();
  //todo get the diffs
  $.ajax(
    '/dfiddle/save/@id/'+what, {
    type: 'POST',
    data: $.param({
      newName : name,
      reactor : '@reactor',
      specWpath : specWpath,
      storyWpath : storyWpath,
      spec : editor1.getValue(),
      story : editor.getValue()
    }),
    contentType: 'application/x-www-form-urlencoded',
    success: function(data) {
      location.reload();
      @*location = '/dfiddle/playDom/@id?what='+newName, {*@
    },
    error  : function(x) {
      console.log( "ERR "+x.toString());
    }
  });
}

</script>

<script type="text/javascript" src="@routes.Assets.at("vendor/jshint.js")"></script>

<script>
var jsh = function(code) {
  JSHINT(code);
  var ret = JSHINT.data();

  var er = 'Line\tReason\n';

  document.getElementById('pre3b_@id').innerText = "";

  if(JSHINT.data().errors) {
    JSHINT.data().errors.forEach(function(e){
      er = er+e.line + '\t\t'+e.reason+'\n';
    })
  }

  document.getElementById('pre3b_@id').innerText = er;
}
</script>

<script src="@routes.Assets.at("javascripts/rk-contentassist.js")"></script>
<script src="@routes.Assets.at("javascripts/weDieselDom.js")"></script>

<script src="@routes.Assets.at("ace-builds/src/ace.js")" type="text/javascript" charset="utf-8"></script>

<script src="@routes.Assets.at("ace-builds/src/mode-nvp1.js")" type="text/javascript" charset="utf-8"></script>
<script src="@routes.Assets.at("ace-builds/src/ext-language_tools.js")" type="text/javascript" charset="utf-8"></script>

@*<script type="text/javascript" src="/sfiddle/tempAsset/@id/gLexer.js")"></script>*@
@*<script type="text/javascript" src="/sfiddle/tempAsset/@id/gParser.js")"></script>*@

<script>
  var langTools = ace.require("ace/ext/language_tools");

  var editor1 = ace.edit("pre1_@id");
  @if(_root_.admin.Config.isLight(au)) {
  editor1.setTheme ( "ace/theme/crimson_editor" ) ;
} else {
  editor1.setTheme ( "ace/theme/twilight" ) ;
}
  editor1.getSession().setMode("ace/mode/nvp1");

  var editor = ace.edit("pre3_@id");
  @if(_root_.admin.Config.isLight(au)) {
  editor.setTheme ( "ace/theme/crimson_editor" ) ;
} else {
  editor.setTheme ( "ace/theme/twilight" ) ;
}
  editor.getSession().setMode("ace/mode/nvp1");

  editor1.setOptions({
    enableBasicAutocompletion: true,
    enableLiveAutocomplete:  true,
    enableLiveAutocompletion:  true
  });
  editor.setOptions({
    enableBasicAutocompletion: true,
    enableLiveAutocomplete:  true,
    enableLiveAutocompletion:  true
  });

  //todo can't have two editors with two completers...
  //todo I could simulate it with an IF inside instCompletions
  var domCompleter = {
    getCompletions: domCompl(false)
  };
  var instCompleter = {
    getCompletions: domCompl(true)
  };

  // delegate the keywords to the xtext generated completer
  var keyWordCompleter = {
    getCompletions: function(editor, session, pos, prefix, callback) {
        var state = editor.session.getState(pos.row);
        var completions = session.$mode.getCompletions(state, session, pos, prefix);
        callback(null, completions);
    }
  };

  //  langTools.addCompleter(instCompleter);
  langTools.setCompleters([keyWordCompleter, instCompleter]);

editor1.commands.addCommand({
    name: "gui",
    bindKey: {win: "Ctrl-G", mac: "Command-G"},
    exec: codeGui
});
editor.commands.addCommand({
    name: "gui",
    bindKey: {win: "Ctrl-G", mac: "Command-G"},
    exec: codeGui
});

  //jsh(editor.getValue());

  var domChanged=true;
  var instChanged=true;

  editor1.getSession().on('change', function(e) {
    domChanged=true;
  });

  editor.getSession().on('change', function(e) {
    instChanged=true;
  });

setInterval(function(){
   if(domChanged) {
     domChanged=false;
     runpill_@{id}('@{id}');
     }
   if(instChanged) {
     instChanged=false;
     runpill2_@{id}('@{id}');
     }
},500);

</script>

<div id="oneModal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <p>?</p>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script>
    // clear modal contents on close
    $('#oneModal').on('hidden.bs.modal', function (e) {
        $("#oneModal > div > div > div.modal-body").html('...');
    })

  function popupContent (content) {
    loadInDivContent("#oneModal > div > div > div.modal-body", content);
    $("#oneModal").modal('show');
  }

  function loadInDivContent(div, content, complete) {
    $(div).html(content);
  }

  function popupUrl(url) {
    loadInDiv("#oneModal > div > div > div.modal-body", url);
    $("#oneModal").modal('show');
  }

  function loadInDiv(div, url, complete) {
    $.ajaxSetup({
    dataFilter:lookupLabels(url),
    cache: false
    });

    $(div).load(url, complete);
  }

</script>

